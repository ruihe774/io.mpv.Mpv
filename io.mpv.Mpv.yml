id: io.mpv.Mpv
runtime: org.freedesktop.Platform
runtime-version: '24.08'
sdk: org.freedesktop.Sdk
command: mpv
rename-desktop-file: mpv.desktop
rename-icon: mpv

add-build-extensions:
  org.freedesktop.Platform.ffmpeg-full:
    version: '24.08'
    directory: lib/ffmpeg
    add-ld-path: .
    remove-after-build: false
    no-autodownload: false

finish-args:
  - --share=ipc
  - --socket=wayland
  - --device=dri
  - --share=network
  - --socket=pulseaudio
  - --filesystem=xdg-pictures/Screenshots:create
  - --filesystem=home:ro
  - --filesystem=xdg-run/pipewire-0:ro

cleanup:
  - '*.la'
  - '*.a'

modules:
  - name: mpv
    buildsystem: meson
    config-opts:
      - -Dbuild-date=false
      - -Dmanpage-build=disabled
      - -Dlua=lua
      - -Dbuildtype=release
      - -Db_lto=true
      - -Db_ndebug=true
      - -Db_pie=true
      - -Dcpp_eh=none
      - -Dcpp_rtti=false
    build-options:
      cflags: -march=native
      cflags-override: true
      cppflags: ''
      cppflags-override: true
      cxxflags: -march=native
      cxxflags-override: true
      ldflags: ''
      ldflags-override: true
      strip: true
    cleanup:
      - /include
      - /lib/pkgconfig
    post-install:
      - echo "screenshot-directory=~/Pictures/Screenshots" > /app/etc/mpv/mpv.conf
    sources:
      - type: git
        url: https://github.com/mpv-player/mpv.git
        tag: v0.39.0
        commit: a0fba7be57f3822d967b04f0f6b6d6341e7516e7
        x-checker-data:
          type: git
          tag-pattern: ^v([\d.]+)$
      - type: git
        url: https://github.com/haasn/libplacebo.git
        mirror-urls:
          - https://code.videolan.org/videolan/libplacebo.git
        tag: v7.349.0
        commit: 1fd3c7bde7b943fe8985c893310b5269a09b46c5
        dest: subprojects/libplacebo
        x-checker-data:
          type: git
          tag-pattern: ^v([\d.]+)$
      - type: git
        url: https://github.com/libass/libass.git
        tag: 0.17.3
        commit: e46aedea0a0d17da4c4ef49d84b94a7994664ab5
        dest: subprojects/libass
        x-checker-data:
          type: git
          tag-pattern: ^(\d\.\d{1,3}\.\d{1,2})$
      - type: archive
        url: https://www.lua.org/ftp/lua-5.1.5.tar.gz
        sha256: 2640fc56a795f29d28ef15e13c34a47e223960b0240e8cb0a82d9b0738695333
        dest: subprojects/lua
      - type: file
        path: lua51/meson.build
        dest: subprojects/lua
      - type: patch
        paths:
          - lua51/0001-visibility.patch
          - lua51/0002-Fix-stack-overflow-in-vararg-functions.patch
          - lua51/0003-fix-call-render-function-again.patch
        dest: subprojects/lua
      - type: file
        path: io.mpv.Mpv.metainfo.xml
      - type: shell
        commands:
          - install -Dm644 io.mpv.Mpv.metainfo.xml /app/share/metainfo/io.mpv.Mpv.metainfo.xml
