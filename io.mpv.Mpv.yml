id: io.mpv.Mpv
runtime: org.freedesktop.Platform
runtime-version: '24.08'
sdk: org.freedesktop.Sdk
command: mpv
rename-desktop-file: mpv.desktop
rename-icon: mpv

add-build-extensions:
  org.freedesktop.Platform.ffmpeg-full:
    version: '24.08'
    directory: lib/ffmpeg
    add-ld-path: .
    remove-after-build: false
    no-autodownload: false

finish-args:
  - --share=ipc
  - --socket=wayland
  - --device=dri
  - --share=network
  - --socket=pulseaudio
  - --filesystem=xdg-pictures/Screenshots:create
  - --filesystem=home:ro
  - --filesystem=xdg-run/pipewire-0:ro

cleanup:
  - '*.la'
  - '*.a'

modules:
  - name: mpv
    buildsystem: meson
    config-opts:
      - -Dbuildtype=plain
      - -Ddefault_library=static
      - -Dbuild-date=false
      - -Dlua=luajit
    build-options:
      cflags: -march=x86-64-v3 -flto=auto -fno-fat-lto-objects
      cxxflags: -march=x86-64-v3 -flto=auto -fno-fat-lto-objects
    cleanup:
      - /include
      - /lib/pkgconfig
    post-install:
      - echo "screenshot-directory=~/Pictures/Screenshots" > /app/etc/mpv/mpv.conf
    sources:
      - type: git
        url: https://github.com/mpv-player/mpv.git
        tag: v0.39.0
        commit: a0fba7be57f3822d967b04f0f6b6d6341e7516e7
        x-checker-data:
          type: git
          tag-pattern: ^v([\d.]+)$
      - type: git
        url: https://github.com/haasn/libplacebo.git
        mirror-urls:
          - https://code.videolan.org/videolan/libplacebo.git
        tag: v7.349.0
        commit: 1fd3c7bde7b943fe8985c893310b5269a09b46c5
        dest: subprojects/libplacebo
        x-checker-data:
          type: git
          tag-pattern: ^v([\d.]+)$
      - type: git
        url: https://github.com/libass/libass.git
        tag: 0.17.3
        commit: e46aedea0a0d17da4c4ef49d84b94a7994664ab5
        dest: subprojects/libass
        x-checker-data:
          type: git
          tag-pattern: ^(\d\.\d{1,3}\.\d{1,2})$
      - type: git
        url: https://github.com/LuaJIT/LuaJIT.git
        mirror-urls:
          - https://luajit.org/git/luajit.git
        commit: f725e44cda8f359869bf8f92ce71787ddca45618
        dest: subprojects/luajit
      - type: file
        path: luajit/meson.build
        dest: subprojects/luajit
      - type: file
        path: luajit/src.meson.build
        dest: subprojects/luajit/src
        dest-filename: meson.build
      - type: patch
        path: luajit/0001-visibility.patch
        dest: subprojects/luajit
      - type: file
        path: io.mpv.Mpv.metainfo.xml
      - type: shell
        commands:
          - install -Dm644 io.mpv.Mpv.metainfo.xml /app/share/metainfo/io.mpv.Mpv.metainfo.xml
