id: io.mpv.Mpv
runtime: org.freedesktop.Platform
runtime-version: '23.08'
sdk: org.freedesktop.Sdk
command: mpv
rename-desktop-file: mpv.desktop
rename-icon: mpv

add-build-extensions:
  org.freedesktop.Platform.ffmpeg-full:
    version: '23.08'
    directory: lib/ffmpeg
    add-ld-path: .
    remove-after-build: false
    no-autodownload: false

finish-args:
  - --share=ipc
  - --socket=x11
  - --socket=wayland
  - --device=dri
  - --share=network
  - --socket=pulseaudio
  - --filesystem=xdg-pictures/Screenshots:create
  - --filesystem=home:ro
  - --filesystem=xdg-run/pipewire-0:ro

cleanup:
  - '*.la'
  - '*.a'
  - /lib/lua

modules:
  - shared-modules/lua5.1/lua-5.1.5.json

  - name: libass
    cleanup:
      - /include
      - /lib/pkgconfig
    config-opts:
      - --disable-static
    sources:
      - type: git
        url: https://github.com/libass/libass.git
        tag: 0.17.2
        commit: cbb48cc4f2f076300004b8b06a86bec55281d0c2
        x-checker-data:
          type: git
          tag-pattern: ^(\d\.\d{1,3}\.\d{1,2})$

  - name: mpv
    buildsystem: meson
    config-opts:
      - -Dbuild-date=false
    cleanup:
      - /include
      - /lib/pkgconfig
    post-install:
      - echo "screenshot-directory=~/Pictures/Screenshots" > /app/etc/mpv/mpv.conf
    sources:
      - type: git
        url: https://github.com/mpv-player/mpv.git
        tag: v0.38.0
        commit: 02254b92dd237f03aa0a151c2a68778c4ea848f9
        x-checker-data:
          type: git
          tag-pattern: ^v([\d.]+)$
      - type: git
        url: https://github.com/haasn/libplacebo.git
        mirror-urls:
          - https://code.videolan.org/videolan/libplacebo.git
        tag: v6.338.2
        commit: 64c1954570f1cd57f8570a57e51fb0249b57bb90
        dest: subprojects/libplacebo
        x-checker-data:
          type: git
          tag-pattern: ^v([\d.]+)$
      - type: file
        path: io.mpv.Mpv.appdata.xml
      # Automatically update version and date in io.mpv.Mpv.appdata.xml
      # Then install io.mpv.Mpv.appdata.xml
      - type: shell
        commands:
          - sed -i "s/date=\"[0-9-]*\"/date=\"$(git log -n1 --pretty=format:%ad --date=short
            VERSION)\"/" io.mpv.Mpv.appdata.xml
          - sed -i "s/version=\"[0-9.]*\"/version=\"$(cat VERSION)\"/" io.mpv.Mpv.appdata.xml
          # This doesn't find the file.
          # - install -D -m644 $FLATPAK_ID.appdata.xml /app/share/appdata/$FLATPAK_ID.appdata.xml
          - mkdir -p /app/share/appdata
          - mv $FLATPAK_ID.appdata.xml /app/share/appdata/$FLATPAK_ID.appdata.xml
          - chmod 644 /app/share/appdata/$FLATPAK_ID.appdata.xml
      - type: shell
        commands:
          - sed -i "s/#if (GLSLANG_VERSION_MAJOR \* 1000 + GLSLANG_VERSION_MINOR)/#if 0/" subprojects/libplacebo/src/glsl/glslang.cc
